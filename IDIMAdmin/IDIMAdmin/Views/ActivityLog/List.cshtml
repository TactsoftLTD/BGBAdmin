@using IDIMAdmin.Extentions
@using IDIMAdmin.Extentions.File
@using IDIMAdmin.Models.Admin
@model ActivityLogSearchVm
@{
    ViewBag.Title = "Activity Log";
}

<div class='col-xs-12'>
    <div class="page-title">
        <div class="pull-left">
            <h1 class="title">Activity Log</h1>
        </div>
        <div class="pull-right hidden-xs">
            <ol class="breadcrumb">
                <li>
                    <a href="@Url.Action("Index","Dashboard")"><i class="fa fa-home"></i>Dashboard</a>
                </li>
                <li class="active">
                    <strong>Activity Log</strong>
                </li>
            </ol>
        </div>
    </div>
</div>
<div class="clearfix"></div>

<div class="col-lg-12">
    <section class="box ">
        <header class="panel_header">
            <h2 class="title pull-left">List</h2>
        </header>
        <div class="content-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        @Html.Label("UserName or UserId", new { @class = "control-label" })
                        @Html.TextBoxFor(model => model.UserName, new { @class = "form-control", id = "userId" })
                        @Html.ValidationMessageFor(model => model.UserId)
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        @Html.LabelFor(m => m.ApplicationId, new { @class = "control-label" })
                        @Html.DropDownListFor(m => m.ApplicationId, Model.ApplicationDropdown, "Select Application", new { @class = " select2", id = "applicationId" })
                        @Html.ValidationMessageFor(model => model.ApplicationId)
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        @Html.LabelFor(model => model.StartDate, new { @class = "control-label" })
                        <div class="input-group date">
                            @Html.TextBoxFor(model => model.StartDate, new { @class = "form-control datepicker", id = "startDate", placeholder = "Select Start Date" })
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                        </div>
                        @Html.ValidationMessageFor(model => model.StartDate)
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        @Html.LabelFor(model => model.EndDate, new { @class = "control-label" })
                        <div class="input-group date">
                            @Html.TextBoxFor(model => model.EndDate, new { @class = "form-control datepicker", id = "endDate", placeholder = "Select End Date" })
                            <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                        </div>
                        @Html.ValidationMessageFor(model => model.EndDate)
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <input type="submit" class="btn btn-success pull-right" id="filter" value="Search" />
                        <input type="button" id="clear" class="btn btn-default pull-left" value="Clear" />
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12" style="margin-top: 20px;">
                    <div class="row" style="margin-bottom: -20px;">
                        <div class="col-md-4 pull-right">
                            <div class="form-group">
                                @Html.Label("Search", new { @class = "control-label" })
                                @Html.TextBoxFor(model => model.SearchValues, new { @class = "form-control", id = "searchValues" })
                                @Html.ValidationMessageFor(model => model.SearchValues)
                            </div>
                        </div>
                    </div>
                    <table id="DataGrid" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>UserName</th>
                                <th>Personal No</th>
                                <th>ApplicationName</th>
                                <th>Menu Name</th>
                                <th>Request Type</th>
                                <th>Activity Time</th>
                                <th>Activity Detail</th>
                                <th>Action</th>
                            </tr>
                        </thead>

                    </table>
                </div>
            </div>
        </div>
    </section>
</div>

@section Scripts{

    <script>
        var itemId = 0;
        var row = null;
        var table;

        $(document).ready(function () {
            table = $('#DataGrid').DataTable({
                "bProcessing": true,
                "bServerSide": true,
                "bFilter": false,
                "ordering": false,                
                "ajax": {
                    "url": baseUrl + "/ActivityLog/LoadData",
                    "type": "POST",
                    "datatype": "json",
                    data: function (d) {
                        d.searchValue = d.search.value; // ✅ send built-in search term
                    }
                },
                "fnServerParams": function (aoData) {
                    aoData.userId = $("#userId").val();
                    aoData.applicationId = $("#applicationId").val();
                    aoData.startDate = $("#startDate").val();
                    aoData.endDate = $("#endDate").val();
                    aoData.searchValues = $("#searchValues").val();
                },
                "columnDefs": [
                    //{
                    //    "targets": [1, 2, 3, 5],  // Disable ordering for columns 2, 3, and 6 (0-based index)
                    //    "orderable": false
                    //},
                    {
                        "targets": [7],  // Column 5 (0-based index) to render the hyperlink
                        "render": function (data, type, row) {
                            return `<a onclick="window.location.href= baseUrl + '/ActivityLog/Detail/${data}'" style="cursor: pointer;"><span class="label label-info"><i class="fa fa-info"></i>Details</a>`;
                        }
                    }
                ]

            });
        });

        $("#filter").click(function () {
            table.draw();
        });
        $("#searchValues").on('change', function () {
            table.ajax.reload(); // ✅ reload DataTables and send the new searchValue
        });

        $("#clear").click(function () {
            $(".select2").val("").trigger("change");
            $("#userId").val("");
            $("#startDate").val("");
            $("#endDate").val("");
            table.draw();
        });
    </script>
}

